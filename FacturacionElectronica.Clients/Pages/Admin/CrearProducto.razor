@page "/admin/productos/crear"
@layout AdminLayout

@using System.ComponentModel.DataAnnotations
@using FacturacionElectronica.Clients.DTOs
@using FacturacionElectronica.Clients.Services
@inject ProductoApiService ApiService

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="form-card">
            <div class="form-card-header">
                <h3><span class="oi oi-box"></span> Crear Nuevo Producto</h3>
            </div>
            <div class="form-card-body">
                @if (isLoading)
                {
                    <p>Cargando...</p>
                }
                else
                {
                    <EditForm Model="@formModel" OnValidSubmit="HandleCrearProducto">
                        <DataAnnotationsValidator />

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success">@successMessage</div>
                        }
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        <div class="mb-3">
                            <label class="form-label">Tipo de Producto (Categoría)</label>
                            <InputText @bind-Value="formModel.TipoProducto" class="form-control" list="tipos-producto-existentes" placeholder="Ej: Lácteos" />
                            <datalist id="tipos-producto-existentes">
                                @foreach (var tipo in tiposDeProducto)
                                {
                                    <option value="@tipo"></option>
                                }
                            </datalist>
                            <ValidationMessage For="@(() => formModel.TipoProducto)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto</label>
                            <InputText @bind-Value="formModel.Nombre" class="form-control" placeholder="Ej: Leche Deslactosada 1L" />
                            <ValidationMessage For="@(() => formModel.Nombre)" />
                        </div>

                        <div class="form-actions mt-4">
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span> Guardando...</span>
                                }
                                else
                                {
                                    <span><span class="oi oi-plus"></span> Guardar Producto</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private class ProductoFormModel
    {
        [Required(ErrorMessage = "El tipo de producto es obligatorio.")]
        public string TipoProducto { get; set; }

        [Required(ErrorMessage = "El nombre del producto es obligatorio.")]
        public string Nombre { get; set; }
    }

    private ProductoFormModel formModel = new();

    private bool isLoading = true;
    private bool isSaving = false;
    private string? successMessage;
    private string? errorMessage;

    private List<string> tiposDeProducto = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }

    private async Task LoadInitialData()
    {
        try
        {
            // El servicio ahora devuelve el DTO correcto
            var productos = await ApiService.GetProductosAsync();
            tiposDeProducto = productos.Select(p => p.ProductId.ToString()).Distinct().ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error fatal al cargar datos: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleCrearProducto()
    {
        isSaving = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            // Creamos el DTO correcto para la API
            var request = new ProductCreateDto(formModel.TipoProducto, formModel.Nombre);

            HttpResponseMessage response = await ApiService.AddProductoAsync(request);

            if (response.IsSuccessStatusCode)
            {
                successMessage = $"¡Producto '{formModel.Nombre}' creado con éxito!";
                ResetForm();
                await LoadInitialData(); // Recargar la lista de tipos de producto
            }
            else
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error al guardar: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error de conexión: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ResetForm()
    {
        formModel = new();
    }
}
