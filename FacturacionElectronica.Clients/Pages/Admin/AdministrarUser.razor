@page "/admin/usuarios"
@layout AdminLayout

@using FacturacionElectronica.Clients.DTOs
@using FacturacionElectronica.Clients.Services
@inject UsuarioApiService ApiService

@if (isCreatingUser)
{
    <!-- ================================================== -->
    <!-- =============== FORMULARIO CREAR USUARIO ========= -->
    <!-- ================================================== -->
    <div class="row justify-content-center animate__animated animate__fadeIn">
        <div class="col-lg-8">

            <div class="cliente-form-wrapper">
                <div class="cliente-form-card cliente-form-card-create">

                    <!-- ======== HEADER ======== -->
                    <div class="cliente-form-card-header colored-header bg-primary text-white">
                        <h4><span class="oi oi-person"></span> Crear Nuevo Usuario</h4>
                        <p>Complete los datos para registrar un nuevo usuario del sistema.</p>
                    </div>

                    <!-- ======== CUERPO ======== -->
                    <div class="cliente-form-card-body">

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger text-center">@errorMessage</div>
                        }

                        <EditForm Model="@newUser" OnValidSubmit="@HandleCreateUser">
                            <DataAnnotationsValidator />

                            <!-- NOMBRE -->
                            <div class="mb-3">
                                <label class="form-label">Nombre</label>
                                <InputText class="form-control"
                                           @bind-Value="newUser.Nombre"
                                           placeholder="Ej: Juan" />
                                <ValidationMessage For="@(() => newUser.Nombre)" class="validation-message" />
                            </div>

                            <!-- APELLIDO -->
                            <div class="mb-3">
                                <label class="form-label">Apellido</label>
                                <InputText class="form-control"
                                           @bind-Value="newUser.Apellido"
                                           placeholder="Ej: Pérez" />
                                <ValidationMessage For="@(() => newUser.Apellido)" class="validation-message" />
                            </div>

                            <!-- CORREO -->
                            <div class="mb-3">
                                <label class="form-label">Correo Electrónico</label>
                                <InputText class="form-control"
                                           @bind-Value="newUser.Correo"
                                           placeholder="usuario@ejemplo.com" />
                                <ValidationMessage For="@(() => newUser.Correo)" class="validation-message" />
                            </div>

                            <!-- CONTRASEÑA -->
                            <div class="mb-3">
                                <label class="form-label">Contraseña</label>
                                <InputText type="password"
                                           class="form-control"
                                           @bind-Value="newUser.Contrasena"
                                           placeholder="Mínimo 8 caracteres" />
                                <ValidationMessage For="@(() => newUser.Contrasena)" class="validation-message" />
                            </div>

                            <!-- ROL -->
                            <div class="mb-3">
                                <label class="form-label">Rol del Usuario</label>
                                <InputSelect class="form-select" @bind-Value="newUser.Rol">
                                    <option value="" disabled selected>Seleccione un rol</option>
                                    <option value="admin">Administrador</option>
                                    <option value="empleado">Empleado</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => newUser.Rol)" class="validation-message" />
                            </div>

                            <!-- ======== BOTONES ======== -->
                            <div class="form-actions mt-4 pt-3 border-top d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" @onclick="CancelCreate">
                                    <span class="oi oi-arrow-left"></span> Cancelar
                                </button>

                                <button type="submit" class="btn btn-success" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <span><span class="oi oi-check"></span> Guardar Usuario</span>
                                    }
                                </button>
                            </div>
                        </EditForm>

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="success-message-box text-center mt-3">
                                @successMessage
                            </div>
                        }
                    </div>

                </div>
            </div>

        </div>
    </div>
}
else
{
    <!-- ================================================== -->
    <!-- =========== TABLA GESTIÓN DE USUARIOS ============ -->
    <!-- ================================================== -->
    <div class="nav-card">
        <div class="form-card-header">
            <h3>
                <span class="oi oi-people"></span>
                Gestión de Usuarios
            </h3>
        </div>

        <div class="p-4">
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            @if (isLoading)
            {
                <p class="text-center"><em>Cargando usuarios...</em></p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table-theme">
                        <thead>
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Correo Electrónico</th>
                                <th>Rol</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in users)
                            {
                                <tr>
                                    <td>@user.Nombre @user.Apellido</td>
                                    <td>@user.Correo</td>
                                    <td>@user.Rol</td>
                                    <td>
                                        <select class="form-select form-select-sm status-select @(user.Estado == "activo" ? "status-active" : "status-inactive")"
                                                @onchange="(e) => HandleStatusChange(user, e)">
                                            <option value="activo" selected="@(user.Estado == "activo")">Activo</option>
                                            <option value="inactivo" selected="@(user.Estado == "inactivo")">Inactivo</option>
                                        </select>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <hr />

                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-primary" @onclick="ShowCreateForm">
                        <span class="oi oi-plus"></span> Agregar Nuevo Usuario
                    </button>
                </div>
            }
        </div>
    </div>
}

@code {
    private List<UserDto> users = new();
    private bool isLoading = true;

    private bool isCreatingUser = false;
    private bool isSaving = false;
    private CreateUserDto newUser = new();

    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync() => await LoadUsers();

    private async Task LoadUsers()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            users = await ApiService.GetUsuariosAsync() ?? new List<UserDto>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar los usuarios: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowCreateForm()
    {
        isCreatingUser = true;
        newUser = new();
        errorMessage = null;
        successMessage = null;
    }

    private void CancelCreate() => isCreatingUser = false;

    private async Task HandleCreateUser()
    {
        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var createdUser = await ApiService.CreateUserAsync(newUser);
            successMessage = $"Usuario '{createdUser.Nombre}' creado con éxito.";
            isCreatingUser = false;
            await LoadUsers();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al crear el usuario: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleStatusChange(UserDto user, ChangeEventArgs e)
    {
        var newStatus = e.Value?.ToString();
        if (user == null || string.IsNullOrEmpty(newStatus)) return;

        var originalStatus = user.Estado;
        user.Estado = newStatus;

        successMessage = null;
        errorMessage = null;

        try
        {
            var updateDto = new UpdateUserStatusDto { Estado = newStatus };
            await ApiService.UpdateUserStatusAsync(user.Id, updateDto);
            successMessage = $"El estado de {user.Nombre} se actualizó a '{newStatus}'.";
        }
        catch (Exception ex)
        {
            user.Estado = originalStatus;
            errorMessage = $"Error al actualizar el estado para {user.Nombre}: {ex.Message}";
        }

        StateHasChanged();
    }
}

<style>
    .status-select {
        border-radius: 1rem;
        border-width: 2px;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        min-width: 100px;
        text-align: center;
    }

    .status-active {
        background-color: rgba(26, 188, 156, 0.2);
        border-color: #1abc9c;
        color: #1abc9c;
    }

    .status-inactive {
        background-color: rgba(108, 117, 125, 0.2);
        border-color: #6c757d;
        color: #6c757d;
    }

    /* Estilos compartidos con productos */
    .cliente-form-card {
        border-radius: 10px;
        border: 1px solid #ddd;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 0 12px rgba(0,0,0,0.05);
    }

    .cliente-form-card-header {
        padding: 1.2rem 1.5rem;
        font-weight: 600;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .cliente-form-card-body {
        padding: 1.5rem;
    }

    .validation-message {
        color: #e74c3c;
        font-size: 0.85rem;
    }

    .success-message-box {
        padding: 0.75rem;
        border-radius: 6px;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
</style>
