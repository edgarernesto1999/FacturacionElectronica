@page "/"
@using FacturacionElectronica.Clients.Auth
@using FacturacionElectronica.Clients.DTOs

@inject AuthService authService
@inject NavigationManager navigationManager
@inject IJSRuntime JSRuntime

<div class="login-container">
    <!-- Contenedor para las formas animadas del fondo -->
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
        <div class="shape shape-5"></div>
        <div class="shape shape-6"></div>
    </div>

    <!-- Tarjeta del formulario de Login -->
    <div class="login-card">
        <h1>Iniciar Sesión</h1>
        <p>Bienvenido de nuevo</p>

        <EditForm Model="@_loginRequest" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <InputText id="email"
                           class="form-control"
                           @bind-Value="_loginRequest.Correo"
                           placeholder="usuario@ejemplo.com" />
                <ValidationMessage For="@(() => _loginRequest.Correo)" class="validation-message" />
            </div>

            <div class="form-group">
                <label for="password">Contraseña</label>
                <InputText id="password"
                           type="password"
                           class="form-control"
                           @bind-Value="_loginRequest.Contrasena"
                           placeholder="••••••••" />
                <ValidationMessage For="@(() => _loginRequest.Contrasena)" class="validation-message" />
            </div>

            @if (!string.IsNullOrEmpty(_mensajeError))
            {
                <div class="alert alert-danger" role="alert">
                    @_mensajeError
                </div>
            }

            <button type="submit" class="btn-login" disabled="@_procesando">
                @if (_procesando)
                {
                    <span class="spinner-border spinner-border-sm"
                          role="status"
                          aria-hidden="true"></span>
                    <span> Ingresando...</span>
                }
                else
                {
                    <span>Ingresar</span>
                }
            </button>
        </EditForm>
    </div>
</div>

@code {
    private LoginRequestDto _loginRequest = new();
    private string _mensajeError = string.Empty;
    private bool _procesando = false;

    private async Task HandleLogin()
    {
        _procesando = true;
        _mensajeError = string.Empty;

        try
        {
            string userRole = await authService.LoginAsync(_loginRequest);

            switch (userRole?.Trim().ToLower())
            {
                case "admin":
                    navigationManager.NavigateTo("/admin");
                    break;
                case "empleado":
                    navigationManager.NavigateTo("/empleado");
                    break;
                default:
                    _mensajeError = "Rol de usuario no reconocido o credenciales inválidas.";
                    break;
            }
        }
        catch (Exception ex)
        {
            _mensajeError = "Correo o contraseña incorrectos.";
            Console.WriteLine($"Error en login: {ex.Message}");
        }
        finally
        {
            _procesando = false;
        }
    }

    // Inicia la animación del login, pero sin romper la app si el JS no existe
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("initLoginAnimation");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"initLoginAnimation no disponible: {ex.Message}");
            }
        }
    }
}
